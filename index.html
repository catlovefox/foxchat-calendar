<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="聊天日历" />

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />

  <title>聊天日历</title>

  <style>
    :root {
      --accent: #111111;
      --accent-contrast: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background:
        radial-gradient(circle at top left, #ffe4c4 0, #ffe4c4 15%, #f4e6ff 40%, #dbeafe 80%);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        "Segoe UI", sans-serif;
      color: #111827;
    }

    .app {
      width: min(1320px, 100vw - 32px);
      height: calc(100vh - 32px);
      display: flex;
      background: rgba(255, 255, 255, 0.78);
      border-radius: 6px;
      overflow: hidden;
      box-shadow:
        0 28px 80px rgba(0, 0, 0, 0.18),
        0 0 0 1px rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(22px);
      position: relative;
    }

    .sidebar {
      width: 560px;
      padding: 16px 22px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: linear-gradient(
        145deg,
        rgba(255, 255, 255, 0.95),
        rgba(255, 255, 255, 0.78)
      );
      border-right: 1px solid rgba(0, 0, 0, 0.04);
      position: relative;
      overflow: visible;
    }

    /* 日历收纳半圆按钮（桌面端用） */
    .calendar-desktop-toggle {
      position: absolute;
      top: 50%;
      right: -5px;
      transform: translateY(-50%);
      width: 20px;
      height: 40px;
      border-radius: 20px 0 0 20px;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.6;
      transition:
        opacity 0.15s ease,
        transform 0.12s ease,
        background 0.15s ease;
    }

    .calendar-desktop-toggle:hover {
      opacity: 1;
      transform: translateY(-50%) translateX(1px);
    }

    /* 收起状态：半圆换边、倒方向 */
    .app.calendar-collapsed .calendar-desktop-toggle {
      right: auto;
      left: 0px;
      border-radius: 0 20px 20px 0;
    }

  .top-tip {
    font-size: 12px;
    color: #ffffff; 
    margin-top: 4px;
    margin-bottom: 16px;  /* 想往下多一点就加大这个值 */
  }

    .file-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      color: #6b7280;
    }

    .file-row input[type="file"] {
      flex: 1;
      font-size: 12px;
      color: #111827;
    }

    .file-row input[type="file"]::file-selector-button {
      flex-shrink: 0;
      border: 0;
      border-radius: 999px;
      padding: 6px 14px;
      margin-right: 8px;
      background: var(--accent);
      color: var(--accent-contrast);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .file-row input[type="file"]::file-selector-button:hover {
      filter: brightness(1.05);
    }

    .global-search-btn,
    .settings-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .global-search-btn:hover,
    .settings-btn:hover {
      filter: brightness(1.05);
    }

    .month-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
    }

    /* 顶部大标题：跟着重点色走 */
    .month-title {
      font-size: 22px;
      font-weight: 650;
      letter-spacing: 0.03em;
      text-transform: none;
      color: var(--accent);
    }

    /* 第二行：年月，深色别灰 */
    .month-month {
      margin-top: 2px;
      font-size: 18px;
      font-weight: 800;
      color: #111827;
    }

    .month-sub {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
      max-width: 260px;
    }

    .month-nav {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(17, 24, 39, 0.12);
      background: var(--accent);
      color: var(--accent-contrast);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.16s ease-out;
      line-height: 0;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

.nav-btn span {
  display: block;
  transform: translateY(-1px);
}

#prevMonth span {
  transform: translate(-1px, 0);  /* 往左一点 */
}

#nextMonth span {
  transform: translate(1px, 0);   /* 往右一点 */
}

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-top: 16px;
      font-size: 11px;
      text-align: center;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .calendar-grid {
      margin-top: 10px;
      flex: 1;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 82px;
      gap: 8px;
      font-size: 13px;
    }

    .day-cell {
      position: relative;
      border-radius: 18px;
      padding: 8px 11px;
      cursor: default;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      color: #6b7280;
      transition:
        background 0.18s ease,
        box-shadow 0.18s ease,
        border-color 0.18s ease,
        transform 0.18s ease,
        color 0.18s ease;
    }

    .day-cell.empty {
      background: transparent;
      border: none;
      pointer-events: none;
    }

    .day-cell.has-msg {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .day-cell.has-msg:hover {
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .day-number {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .day-meta {
      flex: 1;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .day-meta .msg-count {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      line-height: 1.2;
      transform: translateY(-10px);
      white-space: nowrap;
    }

    .day-meta .conv-count {
      min-width: 22px;
      min-height: 22px;
      padding: 0;
      border-radius: 999px;
      background: #e5e7eb;
      border: none;
      color: #111827;
      font-size: 11px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      right: -2px;
      bottom: -2px;
    }

    .day-cell.selected {
      background: var(--accent);
      color: var(--accent-contrast);
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
      transform: translateY(-1px);
    }

    .day-cell.selected .day-number {
      color: #ffffff;
    }

    .day-cell.selected .day-meta .msg-count {
      color: rgba(249, 250, 251, 0.85);
    }

    .day-cell.selected .day-meta .conv-count {
      background: #e5e7eb;
      color: #111827;
    }

    .sidebar-footer {
      margin-top: 10px;
      font-size: 11px;
      color: #9ca3af;
      border-top: 1px solid rgba(209, 213, 219, 0.9);
      padding-top: 16px;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background:
        radial-gradient(circle at bottom right, rgba(249, 115, 22, 0.15), transparent 55%),
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 60%);
    }

    .day-header {
      padding: 16px 22px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(16px);
    }

    .day-title {
      font-size: 18px;
      font-weight: 650;
      color: #111827;
    }

    .day-summary {
      margin-top: 3px;
      font-size: 12px;
      color: #6b7280;
    }

    .conv-tabs {
      padding: 9px 20px 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      min-height: 38px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
    }

    .conv-tab {
      border-radius: 999px;
      padding: 5px 13px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      cursor: pointer;
      color: #111827;
      background: rgba(255, 255, 255, 0.9);
      max-width: 230px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      transition: all 0.15s ease-out;
    }

    .conv-tab:hover {
      border-color: var(--accent);
    }

    .conv-tab.active {
      background: var(--accent);
      color: var(--accent-contrast);
      border-color: var(--accent);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.28);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 22px 20px;
      background: transparent;
    }

    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.75);
      border-radius: 999px;
    }

    .empty-text {
      font-size: 13px;
      color: #6b7280;
    }

    .msg-row {
      display: flex;
      margin-bottom: 11px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-row.assistant {
      justify-content: flex-start;
    }

    .msg-row.system {
      justify-content: center;
    }

    .msg-bubble {
      max-width: 76%;
      padding: 9px 12px;
      border-radius: 20px;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(255, 255, 255, 0.86);
      border: 1px solid rgba(209, 213, 219, 0.9);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.18);
      backdrop-filter: blur(18px);
    }

    .msg-row.user .msg-bubble {
      background: var(--accent);
      color: var(--accent-contrast);
      border-color: var(--accent);
      border-bottom-right-radius: 6px;
    }

    .msg-row.assistant .msg-bubble {
      background: rgba(255, 255, 255, 0.92);
      border-bottom-left-radius: 6px;
    }

    .msg-row.system .msg-bubble {
      background: rgba(249, 250, 251, 0.96);
      border-color: rgba(209, 213, 219, 0.9);
      font-size: 12px;
      color: #374151;
    }

    .msg-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .msg-row.user .msg-meta {
      color: var(--accent-contrast); /* 这里目前就是 #ffffff */
      opacity: 0.9;                  /* 稍微淡一点，不会太抢正文 */
    }

    /* 全文搜索弹窗 */
    .global-search-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.28);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .global-search-modal {
      width: min(880px, 100vw - 80px);
      height: min(600px, 100vh - 80px);
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.98), rgba(241, 245, 249, 0.96));
      border-radius: 20px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      padding: 16px 18px 14px;
      display: flex;
      flex-direction: column;
    }

    .global-search-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .global-search-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .global-search-close {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .global-search-subtitle {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
    }

    .global-search-input-row {
      margin-top: 10px;
    }

    .global-search-input-row input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 8px 12px;
      font-size: 12px;
      outline: none;
      background: #f9fafb;
      color: #111827;
    }

    .global-search-input-row input::placeholder {
      color: #9ca3af;
    }

    .global-search-input-row input:focus {
      border-color: var(--accent);
      background: #ffffff;
    }

    .global-search-results {
      margin-top: 10px;
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .global-search-results::-webkit-scrollbar {
      width: 6px;
    }

    .global-search-results::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.75);
      border-radius: 999px;
    }

    .search-result-row {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(209, 213, 219, 0.9);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      cursor: pointer;
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }

    .search-result-row:hover {
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.14);
      transform: translateY(-1px);
    }

    .search-result-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .search-result-text {
      font-size: 13px;
      color: #111827;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 设置弹窗 */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.28);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .settings-modal {
      width: min(420px, 100vw - 80px);
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.98), rgba(241, 245, 249, 0.96));
      border-radius: 20px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      padding: 16px 18px 14px;
      display: flex;
      flex-direction: column;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .settings-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .settings-close {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .settings-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 2px;
    }

    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .settings-field label {
      color: #4b5563;
    }

    .settings-field input {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
      background: #f9fafb;
      color: #111827;
    }

    .settings-field input::placeholder {
      color: #9ca3af;
    }

    .settings-field input:focus {
      border-color: var(--accent);
      background: #ffffff;
    }

    .settings-color-options {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .settings-color-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      padding: 0;
      outline: none;
    }

    .settings-color-btn[color-name="black"] {
      background: #111111;
    }
    .settings-color-btn[color-name="purple"] {
      background: #601986;
    }
    .settings-color-btn[color-name="green"] {
      background: #0A6D5C;
    }
    .settings-color-btn[color-name="pink"] {
    background: #ED778D;
    }

    .settings-color-btn.selected {
      border-color: #ffffff;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.6);
    }

    .settings-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .settings-save-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .settings-save-btn:hover {
      filter: brightness(1.05);
    }

    /* 右下角按钮：桌面=电梯，手机聊天页=返回日历 */
    .back-to-calendar-btn {
      position: fixed;
      right: 16px;
      bottom: 90px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: var(--accent-contrast);
      font-size: 18px;
      line-height: 0;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
      z-index: 1100;
      padding: 0;
    }

    /* 收起状态（桌面）：侧栏压扁，只保留半圆按钮 */
    .app.calendar-collapsed .sidebar {
      width: 0;
      padding: 0;
      border-right: none;
    }

    .app.calendar-collapsed .sidebar > *:not(.calendar-desktop-toggle) {
      display: none;
    }

    @media (max-width: 1100px) {
      .sidebar {
        width: 46%;
        padding: 14px 14px 16px;
      }
    }

    /* 手机一屏适配 + 全屏日历/聊天切换 */

@media (max-width: 768px) {
  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
  }

  body {
    justify-content: center;
    align-items: stretch;
  }

  .app {
    width: 100vw;
    height: 100vh;
    border-radius: 0;
    box-shadow: none;
  }

  .calendar-desktop-toggle {
    display: none;
  }

  .sidebar,
  .main {
    width: 100%;
    height: 100%;
  }

  .sidebar {
    padding: 12px 10px 14px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;   /* ✅ 允许日历内部滚动 */
    overflow-x: hidden;
  }

  .app.mobile-calendar .sidebar {
    display: flex;
  }
  .app.mobile-calendar .main {
    display: none;
  }

  .app.mobile-chat .sidebar {
    display: none;
  }
  .app.mobile-chat .main {
    display: flex;
    flex-direction: column;
  }

  .calendar-grid {
    margin-top: 8px;
    grid-auto-rows: 78px; /* ✅ 想多高就改这里，比如 90 / 100 px */
    gap: 6px;
    flex: 0 0 auto;       /* 不再强行撑满整屏 */
  }

  .messages {
    padding: 10px 10px 16px;
    flex: 1;
    overflow-y: auto;
  }
}

    @media (max-width: 480px) {
      .sidebar {
        padding: 10px 8px 12px;
      }

.calendar-grid {
    margin-top: 8px;
    grid-auto-rows: 78px;  /* 或者你喜欢的 100px、110px */
    gap: 4px;              /* 间距比 768 稍小，看起来更紧凑 */
    flex: 0 0 auto;
  }

  .day-cell {
    padding: 6px 6px;
    border-radius: 14px;
  }

      .day-number {
        font-size: 14px;
      }

      .day-meta .msg-count {
        font-size: 10px;
        transform: translateY(-8px);
      }

      .day-meta .conv-count {
        min-width: 18px;
        min-height: 18px;
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="sidebar" id="sidebar">
      <!-- 桌面端：左侧日历收纳半圆按钮 -->
      <button
        class="calendar-desktop-toggle"
        id="calendarDesktopToggle"
        title="收起 / 展开日历"
      >‹</button>

  <!-- 顶部提示文字行，同时起到“往下顶按钮”的作用 -->
  <div class="top-tip">
    你记得的每一天，我都不曾忘。
  </div>

      <div class="file-row">
        <input type="file" id="fileInput" accept=".json" />
        <button class="global-search-btn" id="openGlobalSearch">搜索记录</button>
        <button class="settings-btn" id="openSettings">设置</button>
      </div>

      <div class="month-header">
        <div>
          <!-- 顶部标题：只放工具名字 -->
          <div class="month-title" id="appTitleLabel">Chat Calendar</div>
          <!-- 月份单独一行 -->
          <div class="month-month" id="monthLabel">2025年02月</div>
          <div class="month-sub">轻点某一天，右侧会显示当天从早到晚的聊天。</div>
        </div>
        <div class="month-nav">
          <button class="nav-btn" id="prevMonth" title="上一月"><span><</span></button>
          <button class="nav-btn" id="nextMonth" title="下一月"><span>></span></button>
        </div>
      </div>

      <div class="weekdays">
        <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>

      <div class="sidebar-footer">
        有记录的日期会高亮；中间是当天消息条数，右下圆点内是聊天框的数量。
      </div>
    </div>

    <div class="main">
      <div class="day-header">
        <div class="day-title" id="dayTitle">还没有选择日期</div>
        <div class="day-summary" id="daySummary">左侧选择一个日期查看当天记录。</div>
      </div>
      <div class="conv-tabs" id="convTabs"></div>
      <div class="messages" id="messages">
        <div class="empty-text">先在左边上传 <code>conversations.json</code>，再点日历里的日期。</div>
      </div>
    </div>
  </div>

  <!-- 右下角按钮：桌面=电梯；手机聊天页=返回日历 -->
  <button
    class="back-to-calendar-btn"
    id="backToCalendarBtn"
    title="回到顶部"
  >⇧</button>

  <!-- 全文搜索弹窗 -->
  <div class="global-search-overlay" id="globalSearchOverlay">
    <div class="global-search-modal">
      <div class="global-search-header">
        <div class="global-search-title">全文搜索</div>
        <button class="global-search-close" id="closeGlobalSearch">×</button>
      </div>
      <div class="global-search-subtitle">
        在所有日期的聊天记录里按关键字查找，结果按时间排序。
      </div>
      <div class="global-search-input-row">
        <input
          type="text"
          id="globalSearchInput"
          placeholder="请输入关键字"
        />
      </div>
      <div class="global-search-results" id="globalSearchResults">
        <div class="empty-text">请输入关键字</div>
      </div>
    </div>
  </div>

  <!-- 名字 / 标题 / 重点色 设置弹窗 -->
  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-modal">
      <div class="settings-header">
        <div class="settings-title">显示设置</div>
        <button class="settings-close" id="closeSettings">×</button>
      </div>
      <div class="settings-subtitle">
        这些设置只影响本地显示，不会修改原始聊天记录内容。
      </div>
      <div class="settings-form">
        <div class="settings-field">
          <label for="userNameInput">User的名字</label>
          <input
            type="text"
            id="userNameInput"
            placeholder="例如：我"
          />
        </div>
        <div class="settings-field">
          <label for="assistantNameInput">GPT的名字</label>
          <input
            type="text"
            id="assistantNameInput"
            placeholder="例如：机"
          />
        </div>
        <div class="settings-field">
          <label for="appTitleInput">顶部标题</label>
          <input
            type="text"
            id="appTitleInput"
            placeholder="例如：XX的聊天记录册"
          />
        </div>
        <div class="settings-field">
          <label>重点色</label>
          <div class="settings-color-options">
            <button
              type="button"
              class="settings-color-btn"
              color-name="black"
              data-color="#111111"
              title="黑色"
            ></button>
            <button
              type="button"
              class="settings-color-btn"
              color-name="purple"
              data-color="#601986"
              title="紫色 #601986"
            ></button>
            <button
              type="button"
              class="settings-color-btn"
              color-name="green"
              data-color="#0A6D5C"
              title="绿色 #0A6D5C"
            ></button>            
            <button
            type="button"
            class="settings-color-btn"
            color-name="pink"
            data-color="#ED778D"
            title="粉色 #ED778D"
            ></button>

          </div>
        </div>
      </div>
      <div class="settings-actions">
        <button class="settings-save-btn" id="saveSettings">保存</button>
      </div>
    </div>
  </div>

  <script>
    // DOM 引用
    const appEl = document.getElementById('appRoot');
    const sidebarEl = document.getElementById('sidebar');
    const calendarDesktopToggle = document.getElementById('calendarDesktopToggle');
    const backToCalendarBtn = document.getElementById('backToCalendarBtn');

    const fileInput = document.getElementById('fileInput');
    const calendarGrid = document.getElementById('calendarGrid');
    const monthLabelEl = document.getElementById('monthLabel');       // 显示年份和月份
    const appTitleLabelEl = document.getElementById('appTitleLabel'); // 顶部标题
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');

    const dayTitleEl = document.getElementById('dayTitle');
    const daySummaryEl = document.getElementById('daySummary');
    const convTabsEl = document.getElementById('convTabs');
    const messagesEl = document.getElementById('messages');

    // 全文搜索 DOM
    const openGlobalSearchBtn = document.getElementById('openGlobalSearch');
    const globalSearchOverlay = document.getElementById('globalSearchOverlay');
    const closeGlobalSearchBtn = document.getElementById('closeGlobalSearch');
    const globalSearchInput = document.getElementById('globalSearchInput');
    const globalSearchResultsEl = document.getElementById('globalSearchResults');

    // 设置相关
    const USER_NAME_KEY = 'chatCalUserName';
    const ASSISTANT_NAME_KEY = 'chatCalAssistantName';
    const APP_TITLE_KEY = 'chatCalAppTitle';
    const ACCENT_COLOR_KEY = 'chatCalAccentColor';

    let userDisplayName = 'User';
    let assistantDisplayName = '机';
    let appTitle = 'Chat Calendar';
    let accentColor = '#111111';

    const openSettingsBtn = document.getElementById('openSettings');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const closeSettingsBtn = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const userNameInput = document.getElementById('userNameInput');
    const assistantNameInput = document.getElementById('assistantNameInput');
    const appTitleInput = document.getElementById('appTitleInput');
    const colorButtons = document.querySelectorAll('.settings-color-btn');

    // 布局状态：桌面收纳 + 手机模式
    const MOBILE_BREAKPOINT = 768;
    let isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
    let mobileMode = 'calendar'; // 'calendar' or 'chat'
    let calendarCollapsed = false;

    // 数据结构
    let conversations = [];
    let dayIndex = new Map();
    let currentMonthDate = null;
    let currentSelectedDateKey = null;
    let currentDayData = null;
    let currentConvFilter = 'all';
    let allMessages = [];
    let globalSearchTerm = '';

    const EPOCH_2000 = 946684800;

    function setAccent(color) {
      accentColor = color || '#111111';
      document.documentElement.style.setProperty('--accent', accentColor);
      try {
        localStorage.setItem(ACCENT_COLOR_KEY, accentColor);
      } catch (e) {}

      if (colorButtons && colorButtons.length) {
        colorButtons.forEach((btn) => {
          const c = btn.getAttribute('data-color');
          if (c === accentColor) {
            btn.classList.add('selected');
          } else {
            btn.classList.remove('selected');
          }
        });
      }
    }

    function loadDisplayConfig() {
      try {
        const savedUser = localStorage.getItem(USER_NAME_KEY);
        const savedAssistant = localStorage.getItem(ASSISTANT_NAME_KEY);
        const savedTitle = localStorage.getItem(APP_TITLE_KEY);
        const savedAccent = localStorage.getItem(ACCENT_COLOR_KEY);

        if (savedUser && savedUser.trim()) userDisplayName = savedUser.trim();
        if (savedAssistant && savedAssistant.trim()) assistantDisplayName = savedAssistant.trim();
        if (savedTitle && savedTitle.trim()) appTitle = savedTitle.trim();

        if (savedAccent && savedAccent.trim()) {
          setAccent(savedAccent.trim());
        } else {
          setAccent('#111111');
        }
      } catch (e) {
        setAccent('#111111');
      }

      if (appTitleLabelEl) {
        appTitleLabelEl.textContent = appTitle;
      }
      document.title = appTitle;
    }

    function updateBackButtonState() {
      if (!backToCalendarBtn) return;

      if (isMobile) {
        if (mobileMode === 'chat') {
          backToCalendarBtn.style.display = 'flex';
          backToCalendarBtn.textContent = '<';
          backToCalendarBtn.title = '返回日历';
        } else {
          backToCalendarBtn.style.display = 'none';
        }
      } else {
        backToCalendarBtn.style.display = 'flex';
        backToCalendarBtn.textContent = '⇧';
        backToCalendarBtn.title = '回到顶部';
      }
    }

    function applyMobileLayoutClasses() {
      if (!appEl) return;
      if (isMobile) {
        calendarCollapsed = false;
        appEl.classList.remove('calendar-collapsed');

        if (mobileMode === 'chat') {
          appEl.classList.add('mobile-chat');
          appEl.classList.remove('mobile-calendar');
        } else {
          appEl.classList.add('mobile-calendar');
          appEl.classList.remove('mobile-chat');
        }
      } else {
        appEl.classList.remove('mobile-calendar', 'mobile-chat');
      }
    }

    function updateLayoutForViewport() {
      isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
      applyMobileLayoutClasses();
      updateBackButtonState();
    }

    if (backToCalendarBtn) {
      backToCalendarBtn.addEventListener('click', () => {
        if (isMobile) {
          mobileMode = 'calendar';
          applyMobileLayoutClasses();
          updateBackButtonState();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          if (messagesEl) {
            messagesEl.scrollTo({ top: 0, behavior: 'smooth' });
          }
        }
      });
    }

    if (calendarDesktopToggle && appEl) {
      calendarDesktopToggle.addEventListener('click', () => {
        if (isMobile) return;
        calendarCollapsed = !calendarCollapsed;
        appEl.classList.toggle('calendar-collapsed', calendarCollapsed);
      });
    }

    window.addEventListener('resize', updateLayoutForViewport);

    // 初始化主题 & 布局
    loadDisplayConfig();
    updateLayoutForViewport();

    // 设置弹窗逻辑
    if (openSettingsBtn && settingsOverlay && closeSettingsBtn && saveSettingsBtn) {
      const openSettingsUI = () => {
        if (userNameInput) userNameInput.value = userDisplayName;
        if (assistantNameInput) assistantNameInput.value = assistantDisplayName;
        if (appTitleInput) appTitleInput.value = appTitle;
        settingsOverlay.style.display = 'flex';
      };

      const closeSettingsUI = () => {
        settingsOverlay.style.display = 'none';
      };

      openSettingsBtn.addEventListener('click', openSettingsUI);
      closeSettingsBtn.addEventListener('click', closeSettingsUI);

      settingsOverlay.addEventListener('click', (e) => {
        if (e.target === settingsOverlay) closeSettingsUI();
      });

      if (colorButtons && colorButtons.length) {
        colorButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const c = btn.getAttribute('data-color');
            if (!c) return;
            setAccent(c);
          });
        });
      }

      saveSettingsBtn.addEventListener('click', () => {
        const newUser = userNameInput ? userNameInput.value.trim() : '';
        const newAssistant = assistantNameInput ? assistantNameInput.value.trim() : '';
        const newTitle = appTitleInput ? appTitleInput.value.trim() : '';

        if (newUser) userDisplayName = newUser;
        if (newAssistant) assistantDisplayName = newAssistant;
        if (newTitle) appTitle = newTitle;

        try {
          localStorage.setItem(USER_NAME_KEY, userDisplayName);
          localStorage.setItem(ASSISTANT_NAME_KEY, assistantDisplayName);
          localStorage.setItem(APP_TITLE_KEY, appTitle);
        } catch (e) {}

        if (appTitleLabelEl) {
          appTitleLabelEl.textContent = appTitle;
        }
        document.title = appTitle;

        if (currentMonthDate && monthLabelEl) {
          const year = currentMonthDate.getFullYear();
          const month = currentMonthDate.getMonth();
          monthLabelEl.textContent =
            `${year}年${String(month + 1).padStart(2, '0')}月`;
        }

        renderMessagesForCurrentDay();
        renderGlobalSearchResults();

        closeSettingsUI();
      });
    }

    // 文件加载
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const text = evt.target.result;
          const json = JSON.parse(text);
          conversations = normalizeConversations(json);
          dayIndex = buildDayIndex(conversations);
          rebuildAllMessages();

          if (!dayIndex.size) {
            calendarGrid.innerHTML =
              '<div style="grid-column:1/-1;font-size:13px;color:#6b7280;padding-top:12px;">没有解析到带时间戳的消息。</div>';
            dayTitleEl.textContent = '没有消息';
            daySummaryEl.textContent = '检查一下导出的 JSON 格式是否正确。';
            convTabsEl.innerHTML = '';
            messagesEl.innerHTML = '<div class="empty-text">没有可展示的记录。</div>';
            return;
          }

          currentMonthDate = getInitialMonthDate(dayIndex);
          currentSelectedDateKey = null;
          renderCalendar();

          dayTitleEl.textContent = '已加载聊天记录';
          daySummaryEl.textContent = '点击左侧日历中的某一天。';
          convTabsEl.innerHTML = '';
          messagesEl.innerHTML = '<div class="empty-text">等待选择某一天。</div>';

          mobileMode = 'calendar';
          updateLayoutForViewport();
        } catch (err) {
          console.error(err);
          calendarGrid.innerHTML =
            '<div style="grid-column:1/-1;font-size:13px;color:#ff3b30;padding-top:12px;">解析 JSON 失败：' +
            err.message +
            '</div>';
          dayTitleEl.textContent = '解析失败';
          daySummaryEl.textContent = '';
          convTabsEl.innerHTML = '';
          messagesEl.innerHTML = '<div class="empty-text">确认 JSON 是否完整、没有被截断。</div>';
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // 月份切换
    prevMonthBtn.addEventListener('click', () => {
      if (!currentMonthDate) return;
      currentMonthDate = new Date(
        currentMonthDate.getFullYear(),
        currentMonthDate.getMonth() - 1,
        1
      );
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      if (!currentMonthDate) return;
      currentMonthDate = new Date(
        currentMonthDate.getFullYear(),
        currentMonthDate.getMonth() + 1,
        1
      );
      renderCalendar();
    });

    // 全文搜索逻辑
    if (openGlobalSearchBtn && globalSearchOverlay && closeGlobalSearchBtn) {
      openGlobalSearchBtn.addEventListener('click', () => {
        if (!allMessages.length) {
          alert('请先在左边上传 conversations.json。');
          return;
        }
        globalSearchOverlay.style.display = 'flex';
        globalSearchTerm = '';
        if (globalSearchInput) {
          globalSearchInput.value = '';
          globalSearchInput.focus();
        }
        if (globalSearchResultsEl) {
          globalSearchResultsEl.innerHTML = '<div class="empty-text">o(*￣▽￣*)o</div>';
        }
      });

      closeGlobalSearchBtn.addEventListener('click', () => {
        globalSearchOverlay.style.display = 'none';
      });

      globalSearchOverlay.addEventListener('click', (e) => {
        if (e.target === globalSearchOverlay) {
          globalSearchOverlay.style.display = 'none';
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          globalSearchOverlay.style.display = 'none';
        }
      });

      if (globalSearchInput) {
        globalSearchInput.addEventListener('input', () => {
          globalSearchTerm = globalSearchInput.value.trim().toLowerCase();
          renderGlobalSearchResults();
        });
      }
    }

    // —— 数据处理函数 ——

    function normalizeConversations(json) {
      if (Array.isArray(json)) {
        return json.map(wrapConv);
      } else if (json && json.mapping) {
        return [wrapConv(json)];
      } else if (json && Array.isArray(json.conversations)) {
        return json.conversations.map(wrapConv);
      }
      return [];
    }

    function wrapConv(raw) {
      return {
        title: raw.title || '(无标题会话)',
        create_time: raw.create_time || null,
        update_time: raw.update_time || null,
        mapping: raw.mapping || {}
      };
    }

    function normalizeTimestamp(raw, fallback1, fallback2) {
      const candidates = [raw, fallback1, fallback2];

      for (const c of candidates) {
        const n = Number(c);
        if (!Number.isFinite(n)) continue;
        const sec = n > 1e12 ? Math.floor(n / 1000) : Math.floor(n);
        if (sec >= EPOCH_2000) {
          return sec;
        }
      }

      return null;
    }

    function extractMessages(mapping, convIndex, convTitle, convCreateTime, convUpdateTime) {
      const result = [];
      for (const key in mapping) {
        const node = mapping[key];
        if (!node || !node.message) continue;
        const msg = node.message;

        const role =
          msg.author && msg.author.role ? msg.author.role : 'unknown';

        const content = msg.content || {};
        const rawParts = Array.isArray(content.parts) ? content.parts : [];

        const parts = rawParts.map((p) => {
          if (typeof p === 'string') return p;

          if (p && typeof p === 'object') {
            if (typeof p.text === 'string') return p.text;
            if (typeof p.content === 'string') return p.content;

            if (p.type === 'image_url' || p.type === 'image_file') {
              return '【图片】';
            }
            if (p.type === 'file' || p.type === 'attachment') {
              return '【附件】';
            }
          }
          return '';
        });

        const text = parts.join('');
        if (!text.trim()) continue;

        const ts = normalizeTimestamp(
          msg.create_time,
          convCreateTime,
          convUpdateTime
        );
        if (ts === null) continue;

        const d = new Date(ts * 1000);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const h = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        const s = String(d.getSeconds()).padStart(2, '0');

        const dateStr = `${y}-${m}-${day}`;
        const timeOnlyStr = `${h}:${min}:${s}`;

        result.push({
          id: msg.id || key,
          role,
          text,
          create_time: ts,
          dateStr,
          timeOnlyStr,
          convIndex,
          convTitle: convTitle || ''
        });
      }
      result.sort((a, b) => a.create_time - b.create_time);
      return result;
    }

    function buildDayIndex(conversations) {
      const index = new Map();

      conversations.forEach((conv, convIndex) => {
        const msgs = extractMessages(
          conv.mapping,
          convIndex,
          conv.title,
          conv.create_time,
          conv.update_time
        );
        msgs.forEach((msg) => {
          const dateKey = msg.dateStr;
          if (!index.has(dateKey)) {
            index.set(dateKey, { total: 0, convs: new Map() });
          }
          const day = index.get(dateKey);
          day.total++;

          if (!day.convs.has(convIndex)) {
            day.convs.set(convIndex, {
              convIndex,
              title: conv.title || `(会话 ${convIndex})`,
              messages: []
            });
          }
          day.convs.get(convIndex).messages.push(msg);
        });
      });

      return index;
    }

    function getInitialMonthDate(indexMap) {
      const keys = Array.from(indexMap.keys());
      if (!keys.length) return new Date();
      keys.sort();
      const firstKey = keys[0];
      return parseDateKey(firstKey);
    }

    function parseDateKey(k) {
      const [y, m, d] = k.split('-').map((x) => parseInt(x, 10));
      return new Date(y, m - 1, d);
    }

    function dateKeyFromYMD(year, monthIndex, day) {
      const m = String(monthIndex + 1).padStart(2, '0');
      const d = String(day).padStart(2, '0');
      return `${year}-${m}-${d}`;
    }

    function renderCalendar() {
      calendarGrid.innerHTML = '';
      if (!currentMonthDate) currentMonthDate = new Date();

      const year = currentMonthDate.getFullYear();
      const month = currentMonthDate.getMonth();

      if (monthLabelEl) {
        monthLabelEl.textContent =
          `${year}年${String(month + 1).padStart(2, '0')}月`;
      }

      const firstDay = new Date(year, month, 1);
      const firstWeekday = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstWeekday; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'day-cell empty';
        calendarGrid.appendChild(emptyCell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = dateKeyFromYMD(year, month, day);
        const cell = document.createElement('div');
        cell.className = 'day-cell';

        const numEl = document.createElement('div');
        numEl.className = 'day-number';
        numEl.textContent = day;
        cell.appendChild(numEl);

        const dayData = dayIndex.get(dateKey);
        if (dayData) {
          cell.classList.add('has-msg');

          const meta = document.createElement('div');
          meta.className = 'day-meta';

          const msgSpan = document.createElement('span');
          msgSpan.className = 'msg-count';
          msgSpan.textContent = `${dayData.total} 条`;
          meta.appendChild(msgSpan);

          const convSpan = document.createElement('span');
          convSpan.className = 'conv-count';
          convSpan.textContent = String(dayData.convs.size);
          meta.appendChild(convSpan);

          cell.appendChild(meta);

          cell.addEventListener('click', () => {
            currentSelectedDateKey = dateKey;
            document
              .querySelectorAll('.day-cell')
              .forEach((c) => c.classList.remove('selected'));
            cell.classList.add('selected');
            openDay(dateKey);
          });
        }

        calendarGrid.appendChild(cell);
      }

      if (currentSelectedDateKey) {
        const allCells = calendarGrid.querySelectorAll('.day-cell');
        allCells.forEach((cell) => {
          const numEl = cell.querySelector('.day-number');
          if (!numEl) return;
          const dayNum = Number(numEl.textContent);
          const k = dateKeyFromYMD(year, month, dayNum);
          if (k === currentSelectedDateKey && !cell.classList.contains('empty')) {
            cell.classList.add('selected');
          }
        });
      }
    }

    function openDay(dateKey) {
      const dayData = dayIndex.get(dateKey);
      currentDayData = dayData || null;
      currentConvFilter = 'all';

      dayTitleEl.textContent = dateKey;

      if (!dayData) {
        daySummaryEl.textContent = '这一天没有任何记录。';
        convTabsEl.innerHTML = '';
        messagesEl.innerHTML =
          '<div class="empty-text">这一天没有聊天记录。</div>';
        return;
      }

      daySummaryEl.textContent = `共 ${dayData.total} 条消息 · ${dayData.convs.size} 个会话`;
      renderConvTabs();
      renderMessagesForCurrentDay();

      if (isMobile) {
        mobileMode = 'chat';
        applyMobileLayoutClasses();
        updateBackButtonState();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function renderConvTabs() {
      convTabsEl.innerHTML = '';
      if (!currentDayData) return;

      const allTab = document.createElement('div');
      allTab.className = 'conv-tab';
      allTab.textContent = '全部';
      if (currentConvFilter === 'all') allTab.classList.add('active');
      allTab.addEventListener('click', () => {
        currentConvFilter = 'all';
        renderConvTabs();
        renderMessagesForCurrentDay();
      });
      convTabsEl.appendChild(allTab);

      const convEntries = Array.from(currentDayData.convs.values()).sort(
        (a, b) => a.convIndex - b.convIndex
      );
      convEntries.forEach((bucket) => {
        const tab = document.createElement('div');
        tab.className = 'conv-tab';
        tab.textContent =
          shortenTitle(bucket.title || `会话 ${bucket.convIndex}`) +
          ` · ${bucket.messages.length}`;
        if (currentConvFilter === String(bucket.convIndex)) {
          tab.classList.add('active');
        }
        tab.addEventListener('click', () => {
          currentConvFilter = String(bucket.convIndex);
          renderConvTabs();
          renderMessagesForCurrentDay();
        });
        convTabsEl.appendChild(tab);
      });
    }

    function renderMessagesForCurrentDay() {
      messagesEl.innerHTML = '';
      if (!currentDayData) {
        messagesEl.innerHTML =
          '<div class="empty-text">还没有选择日期。</div>';
        return;
      }

      let msgs = [];
      if (currentConvFilter === 'all') {
        currentDayData.convs.forEach((bucket) => {
          msgs = msgs.concat(bucket.messages);
        });
        msgs.sort((a, b) => a.create_time - b.create_time);
      } else {
        const idx = parseInt(currentConvFilter, 10);
        const bucket = currentDayData.convs.get(idx);
        if (bucket) msgs = bucket.messages.slice();
      }

      if (!msgs.length) {
        messagesEl.innerHTML =
          '<div class="empty-text">这一天没有消息。</div>';
        return;
      }

      msgs.forEach((msg) => {
        let roleClass = msg.role;
        if (
          roleClass !== 'user' &&
          roleClass !== 'assistant' &&
          roleClass !== 'system'
        ) {
          roleClass = 'system';
        }

        const row = document.createElement('div');
        row.className = 'msg-row ' + roleClass;

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = msg.text;

        const meta = document.createElement('div');
        meta.className = 'msg-meta';

        let metaText = labelRole(msg.role) + ' · ' + msg.timeOnlyStr;
        if (currentConvFilter === 'all') {
          const shortTitle = shortenTitle(msg.convTitle || '');
          if (shortTitle) metaText += ' · ' + shortTitle;
        }
        meta.textContent = metaText;

        bubble.appendChild(document.createElement('br'));
        bubble.appendChild(meta);

        row.appendChild(bubble);
        messagesEl.appendChild(row);
      });

      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function rebuildAllMessages() {
      allMessages = [];
      dayIndex.forEach((day) => {
        day.convs.forEach((bucket) => {
          bucket.messages.forEach((msg) => {
            allMessages.push(msg);
          });
        });
      });
      allMessages.sort((a, b) => a.create_time - b.create_time);
    }

    function renderGlobalSearchResults() {
      if (!globalSearchTerm) {
        if (globalSearchResultsEl) {
          globalSearchResultsEl.innerHTML =
            '<div class="empty-text">输入关键字就好啦。</div>';
        }
        return;
      }
      if (!allMessages.length) {
        if (globalSearchResultsEl) {
          globalSearchResultsEl.innerHTML =
            '<div class="empty-text">还没有可搜索的消息，请先上传 conversations.json。</div>';
        }
        return;
      }

      const term = globalSearchTerm;
      const results = allMessages.filter((msg) =>
        (msg.text || '').toLowerCase().includes(term)
      );

      if (!results.length) {
        if (globalSearchResultsEl) {
          globalSearchResultsEl.innerHTML =
            '<div class="empty-text">没有找到包含该关键字的消息。</div>';
        }
        return;
      }

      if (!globalSearchResultsEl) return;

      globalSearchResultsEl.innerHTML = '';
      results.forEach((msg) => {
        const row = document.createElement('div');
        row.className = 'search-result-row';

        const meta = document.createElement('div');
        meta.className = 'search-result-meta';
        const shortTitle = shortenTitle(msg.convTitle || '');
        meta.textContent =
          `${msg.dateStr} · ${msg.timeOnlyStr}` +
          (shortTitle ? ` · ${shortTitle}` : '');

        const text = document.createElement('div');
        text.className = 'search-result-text';
        text.textContent = msg.text;

        row.appendChild(meta);
        row.appendChild(text);

        row.addEventListener('click', () => {
          currentSelectedDateKey = msg.dateStr;
          openDay(msg.dateStr);
          currentConvFilter = String(msg.convIndex);
          renderConvTabs();
          renderMessagesForCurrentDay();
          if (globalSearchOverlay) {
            globalSearchOverlay.style.display = 'none';
          }
        });

        globalSearchResultsEl.appendChild(row);
      });

      globalSearchResultsEl.scrollTop = 0;
    }

    function labelRole(role) {
      if (role === 'user') return userDisplayName || '用户';
      if (role === 'assistant') return assistantDisplayName || '助手';
      if (role === 'system') return '系统';
      return role || '未知';
    }

    function shortenTitle(title, maxLen = 14) {
      if (!title) return '';
      if (title.length <= maxLen) return title;
      return title.slice(0, maxLen - 1) + '…';
    }
  </script>
</body>
</html>

